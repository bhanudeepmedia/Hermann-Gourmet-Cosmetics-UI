<header class="site-header" data-sticky="{{ section.settings.sticky }}">
  <div class="container header-wrapper">
    
    <!-- Mobile Toggle -->
    <button class="mobile-nav-toggle" id="mobile-menu-toggle" aria-label="Menu">
      <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Logo -->
    <div class="header-logo">
      <a href="{{ routes.root_url }}">
        {% if section.settings.logo %}
          <img src="{{ section.settings.logo | img_url: '400x' }}" alt="{{ shop.name }}" loading="eager">
        {% else %}
          <span class="logo-text">{{ section.settings.logo_text }}</span>
        {% endif %}
      </a>
    </div>

    <!-- Desktop Nav (Dynamic Blocks) -->
    <nav class="header-nav">
      <ul class="nav-list">
        {% for link in linklists[section.settings.main_menu].links %}
          <li class="nav-item {% if link.links != blank %}has-dropdown{% endif %}">
            <a href="{{ link.url }}" class="nav-link {% if link.active %}active{% endif %}">
              {{ link.title }}
              {% if link.links != blank %}<i class="fa-solid fa-chevron-down down-arrow"></i>{% endif %}
            </a>

            {% if link.links != blank %}
              <div class="mega-menu-container">
                <div class="container mega-menu-grid">
                  {% for childlink in link.links %}
                    <div class="mega-menu-column">
                      <h4><a href="{{ childlink.url }}">{{ childlink.title }}</a></h4>
                      {% if childlink.links != blank %}
                        <ul>
                          {% for grandchild in childlink.links %}
                            <li><a href="{{ grandchild.url }}">{{ grandchild.title }}</a></li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </div>
                  {% endfor %}
                  
                  <!-- Optional Promo Block (if defined in blocks) -->
                  {% for block in section.blocks %}
                    {% if block.type == 'promo' and block.settings.menu_trigger == link.title %}
                       <div class="mega-menu-column promo-column">
                         <div class="promo-card">
                           {% if block.settings.image %}
                             <img src="{{ block.settings.image | img_url: '400x' }}" alt="Promo">
                           {% endif %}
                           <h5>{{ block.settings.title }}</h5>
                           <p>{{ block.settings.text }}</p>
                           <a href="{{ block.settings.link }}" class="btn-text">Shop Now â†’</a>
                         </div>
                       </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </nav>

    <!-- Icons -->
    <div class="header-icons">
      {% if section.settings.show_search %}
        <a href="{{ routes.search_url }}" class="icon-link"><i class="fa-solid fa-magnifying-glass"></i></a>
      {% endif %}
      {% if shop.customer_accounts_enabled %}
        <a href="{{ routes.account_url }}" class="icon-link"><i class="fa-regular fa-user"></i></a>
      {% endif %}
      <a href="{{ routes.cart_url }}" class="icon-link cart-link">
        <i class="fa-solid fa-basket-shopping"></i>
        <span class="cart-count">{{ cart.item_count }}</span>
      </a>
    </div>
  </div>

  <!-- Mobile Drawer -->
  <div class="mobile-menu-drawer" id="mobile-menu">
    <div class="drawer-header">
      <span class="drawer-title">Menu</span>
      <button class="close-drawer"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="drawer-content">
      <ul class="mobile-links">
        {% for link in linklists[section.settings.main_menu].links %}
          <li>
            <a href="{{ link.url }}">{{ link.title }}</a>
            {% if link.links != blank %}
              <ul class="mobile-sublinks">
                {% for child in link.links %}
                  <li><a href="{{ child.url }}">- {{ child.title }}</a></li>
                {% endfor %}
              </ul>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="mobile-overlay" id="mobile-overlay"></div>
</header>

<style>
  .site-header {
    background: rgba(253, 251, 247, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1rem 0;
    position: relative;
    z-index: 100;
  }
  .site-header[data-sticky="true"] { position: sticky; top: 0; }
  
  .header-wrapper { display: flex; justify-content: space-between; align-items: center; }
  
  .header-logo img { max-height: 50px; }
  .logo-text { font-family: var(--font-heading); font-size: 1.8rem; font-weight: 700; color: var(--c-text); }
  
  .nav-list { display: flex; gap: 2.5rem; list-style: none; margin: 0; padding: 0; }
  .nav-link { font-weight: 500; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.05em; color: var(--c-text); position: relative; padding: 1rem 0; }
  .down-arrow { font-size: 0.7em; margin-left: 5px; opacity: 0.6; }
  
  /* Mega Menu */
  .mega-menu-container {
    position: absolute;
    top: 100%; left: 0; width: 100%;
    background: white;
    border-top: 1px solid #eee;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    opacity: 0; visibility: hidden;
    transform: translateY(10px);
    transition: all 0.2s ease;
    padding: 3rem 0;
  }
  .nav-item:hover .mega-menu-container { opacity: 1; visibility: visible; transform: translateY(0); }
  .mega-menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; }
  .mega-menu-column h4 a { font-family: var(--font-heading); font-size: 1.1rem; color: var(--c-accent); margin-bottom: 1rem; display: block; }
  .mega-menu-column ul { list-style: none; }
  .mega-menu-column li a { color: #666; font-size: 0.95rem; margin-bottom: 0.5rem; display: block; transition: color 0.2s; }
  .mega-menu-column li a:hover { color: var(--c-text); }
  
  .promo-card { background: #F9F3EA; padding: 1.5rem; border-radius: 12px; text-align: center; }
  .promo-card img { width: 100%; border-radius: 8px; margin-bottom: 1rem; }
  .promo-card h5 { font-family: var(--font-heading); margin-bottom: 0.5rem; }
  
  .header-icons { display: flex; gap: 1.5rem; align-items: center; }
  .icon-link { font-size: 1.2rem; position: relative; }
  .cart-count { 
    position: absolute; top: -8px; right: -8px; 
    background: var(--c-accent); color: white; 
    font-size: 0.7rem; width: 18px; height: 18px; 
    border-radius: 50%; display: flex; justify-content: center; align-items: center; 
  }
  
  /* Mobile Drawer */
  .mobile-menu-drawer {
    position: fixed; top: 0; right: -100%; width: 85%; max-width: 400px; height: 100vh;
    background: white; z-index: 1000; transition: right 0.3s ease;
    box-shadow: -5px 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column;
  }
  .mobile-menu-drawer.active { right: 0; }
  .mobile-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s;
  }
  .mobile-overlay.active { opacity: 1; visibility: visible; }
  
  .drawer-header { padding: 1.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  .drawer-title { font-family: var(--font-heading); font-size: 1.5rem; }
  .close-drawer { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
  .drawer-content { padding: 1.5rem; overflow-y: auto; }
  .mobile-links { list-style: none; }
  .mobile-links > li { border-bottom: 1px solid #f5f5f5; padding: 1rem 0; }
  .mobile-links a { font-size: 1.1rem; font-weight: 500; display: block; }
  .mobile-sublinks { margin-top: 0.5rem; padding-left: 1rem; }
  .mobile-sublinks a { font-size: 1rem; color: #666; padding: 0.3rem 0; }

  @media (max-width: 900px) {
    .header-nav { display: none; }
  }
  @media (min-width: 901px) {
    .mobile-nav-toggle { display: none; }
  }
</style>

<script>
  const toggle = document.getElementById('mobile-menu-toggle');
  const drawer = document.getElementById('mobile-menu');
  const overlay = document.getElementById('mobile-overlay');
  const close = document.querySelector('.close-drawer');
  
  function openMenu() {
    drawer.classList.add('active');
    overlay.classList.add('active');
  }
  function closeMenu() {
    drawer.classList.remove('active');
    overlay.classList.remove('active');
  }
  
  if(toggle) toggle.addEventListener('click', openMenu);
  if(close) close.addEventListener('click', closeMenu);
  if(overlay) overlay.addEventListener('click', closeMenu);
</script>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    },
    {
      "type": "text",
      "id": "logo_text",
      "label": "Logo Text",
      "default": "Hermann"
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main Menu",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "sticky",
      "label": "Sticky Header",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "Show Search",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "promo",
      "name": "Menu Promo",
      "settings": [
        {
          "type": "text",
          "id": "menu_trigger",
          "label": "Menu Item to Trigger (Exact Match)",
          "info": "e.g., 'Shop'"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "New Collection"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Check out our latest arrivals."
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ]
}
{% endschema %}
